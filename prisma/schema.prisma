// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Market {
  id                 String   @id
  question           String
  outcomes           Json     // Array of outcome names (e.g., ["Yes", "No"])
  outcomeMapping     Json?    @map("outcome_mapping") // { "YES": "AFC", "NO": "NFC" }
  expiryDate         DateTime
  liquidity          Decimal
  volume24h          Decimal
  categoryTag        String?
  marketSlug         String
  active             Boolean  @default(true)
  tokens             Json     // JSON object: { "YES": "0x...", "NO": "0x..." }
  polymarketMarketId String?  @map("polymarket_market_id")
  yesPrice           Decimal? @map("yes_price")
  noPrice            Decimal? @map("no_price")
  volume             Decimal? @map("volume")
  lastIndexedBlock   BigInt?  @map("last_indexed_block")
  completedEarly     Boolean  @default(false) @map("completed_early")
  createdAt          DateTime @default(now())
  lastUpdated        DateTime @updatedAt @map("last_updated")

  trades         Trade[]
  positions      Position[]
  watchlistItems WatchlistItem[]

  @@index([active])
  @@index([categoryTag])
  @@index([expiryDate])
  @@index([polymarketMarketId])
  @@map("markets")
}

model Trade {
  id            String    @id @default(uuid())
  walletAddress String
  marketId      String
  outcome       String    // "YES" or "NO"
  side          String    // "buy" or "sell"
  price         Decimal
  size          Decimal
  txHash        String?
  blockNumber   BigInt?
  gasUsed       BigInt?
  fee           Decimal?
  timestamp     DateTime  @default(now())
  confirmedAt   DateTime?

  market Market @relation(fields: [marketId], references: [id])

  @@index([walletAddress])
  @@index([marketId])
  @@index([timestamp])
  @@map("trades")
}

model Position {
  id            String   @id @default(uuid())
  walletAddress String
  marketId      String
  outcome       String   // "YES" or "NO"
  avgPrice      Decimal
  size          Decimal
  realizedPnl   Decimal  @default(0)
  unrealizedPnl Decimal  @default(0)
  lastTradeAt   DateTime
  updatedAt     DateTime @updatedAt

  market Market @relation(fields: [marketId], references: [id])

  @@unique([walletAddress, marketId, outcome])
  @@index([walletAddress])
  @@index([marketId])
  @@map("positions")
}

model OrderbookSnapshot {
  id        String   @id @default(uuid())
  marketId  String
  outcome   String   // "YES" or "NO"
  bids      Json     // Array of {price, size}
  asks      Json     // Array of {price, size}
  timestamp DateTime @default(now())
  expiresAt DateTime

  @@unique([marketId, outcome])
  @@index([expiresAt])
  @@map("orderbook_snapshots")
}

model OrderbookEvent {
  id        String   @id @default(uuid())
  marketId  String
  outcome   String   // "YES" or "NO"
  bestBid   Decimal? @map("best_bid")
  bestAsk   Decimal? @map("best_ask")
  midPrice  Decimal? @map("mid_price")
  timestamp DateTime
  source    String   @default("realtime") // "historical" | "realtime"

  @@index([marketId, outcome, timestamp])
  @@index([timestamp])
  @@index([source])
  @@map("orderbook_events")
}

model TradeEvent {
  id        String   @id @default(uuid())
  marketId  String
  outcome   String   // "YES" or "NO"
  price     Decimal
  size      Decimal
  timestamp DateTime
  source    String   @default("realtime") // "historical" | "realtime"

  @@unique([marketId, outcome, timestamp, price, size])
  @@index([marketId, outcome, timestamp])
  @@index([timestamp])
  @@index([source])
  @@map("trade_events")
}

model MarketBackfill {
  marketId             String    @id
  status               String    // "pending" | "in_progress" | "completed" | "failed"
  tradeEventsCount     Int       @default(0)
  orderbookEventsCount Int       @default(0)
  earliestTimestamp    DateTime?
  latestTimestamp      DateTime?
  errorMessage         String?
  startedAt            DateTime?
  completedAt          DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  @@index([status])
  @@map("market_backfills")
}

model AuthNonce {
  walletAddress String   @id @map("wallet_address")
  nonce         String
  timestamp     Int
  expiresAt     DateTime @map("expires_at")
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([expiresAt])
  @@map("auth_nonces")
}

// ============================================================================
// MULTI-INSTRUMENT SUPPORT
// ============================================================================

enum InstrumentType {
  EQUITY
  OPTION
  FUTURE
}

enum InstrumentStatus {
  ACTIVE
  SUSPENDED
  DELISTED
  HALTED
}

model Instrument {
  id               String           @id @default(uuid())
  type             InstrumentType
  status           InstrumentStatus @default(ACTIVE)

  // Identity
  symbol           String
  name             String
  exchange         String?

  // Pricing (generic - not YES/NO)
  lastPrice        Decimal?         @map("last_price")
  bidPrice         Decimal?         @map("bid_price")
  askPrice         Decimal?         @map("ask_price")

  // Metadata
  currency         String           @default("USD")
  lotSize          Decimal          @default(1) @map("lot_size")

  // Tradability
  tradeable        Boolean          @default(true)
  shortable        Boolean          @default(false)
  optionsAvailable Boolean          @default(false) @map("options_available")

  // Issuer Lifecycle (EDGAR Universe Discovery)
  isActive         Boolean          @default(true) @map("is_active")
  firstSeenAt      DateTime?        @map("first_seen_at")
  lastFilingAt     DateTime?        @map("last_filing_at")
  metadataSource   String?          @map("metadata_source") // 'EDGAR', 'MANUAL', etc.
  formerNames      Json?            @map("former_names") // Array of historical names

  // Timestamps
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  // Relations
  identifiers      InstrumentIdentifier[]
  signals          InstrumentSignal[]
  classification   InstrumentClassification?
  competitors      CompetitorRelationship[] @relation("Instrument")
  competitorOf     CompetitorRelationship[] @relation("Competitor")
  factorExposures  FactorExposure[]
  documents        DocumentInstrument[]

  @@unique([type, symbol, exchange])
  @@index([status])
  @@index([symbol])
  @@index([isActive])
  @@index([lastFilingAt])
  @@index([firstSeenAt])
  @@map("instruments")
}

enum IdentifierType {
  CIK
  CUSIP
  ISIN
  FIGI
  TICKER
}

model InstrumentIdentifier {
  id           String         @id @default(uuid())
  instrumentId String         @map("instrument_id")
  type         IdentifierType
  value        String

  instrument   Instrument     @relation(fields: [instrumentId], references: [id], onDelete: Cascade)

  @@unique([instrumentId, type])
  @@index([type, value])
  @@map("instrument_identifiers")
}

// ============================================================================
// SEC EDGAR FILING STORAGE
// ============================================================================

enum FilingType {
  FORM_8K
  FORM_10Q
  FORM_10K
  FORM_424B5
  FORM_S3
  ATM_FILING
  PROXY_DEF14A
  OTHER
}

enum FilingStatus {
  PENDING
  DOWNLOADING
  DOWNLOADED
  PARSED
  ENRICHED
  FAILED
}

model Filing {
  id              String        @id @default(uuid())

  // SEC Identity
  accessionNumber String        @unique @map("accession_number")
  cik             String
  filingType      FilingType    @map("filing_type")
  filingDate      DateTime      @map("filing_date")

  // Status & Storage
  status          FilingStatus  @default(PENDING)
  storagePath     String?       @map("storage_path")
  contentHash     String?       @map("content_hash")

  // Metadata
  companyName     String?       @map("company_name")
  formType        String        @map("form_type")
  reportDate      DateTime?     @map("report_date")

  // Processing
  errorMessage    String?       @map("error_message")
  downloadedAt    DateTime?     @map("downloaded_at")
  parsedAt        DateTime?     @map("parsed_at")

  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  parsedContent   FilingContent?
  facts           FilingFact[]
  signals         InstrumentSignal[]

  @@index([cik, filingDate])
  @@index([status])
  @@index([filingType])
  @@map("filings")
}

model FilingContent {
  id        String   @id @default(uuid())
  filingId  String   @unique @map("filing_id")

  fullText  String   @map("full_text") @db.Text
  sections  Json?
  exhibits  Json?

  wordCount Int      @default(0) @map("word_count")
  parsedAt  DateTime @default(now()) @map("parsed_at")

  filing    Filing   @relation(fields: [filingId], references: [id], onDelete: Cascade)

  @@map("filing_contents")
}

// ============================================================================
// FACT EXTRACTION
// ============================================================================

enum FactType {
  // EDGAR facts (existing)
  ATM_PROGRAM
  SHELF_REGISTRATION
  CONVERTIBLE_DEBT
  REVERSE_SPLIT
  GOING_CONCERN
  LIQUIDITY_STRESS
  EQUITY_RAISE
  DIRECTOR_RESIGNATION
  COVENANT_BREACH
  RESTATEMENT

  // Earnings transcript facts
  LIQUIDITY_LANGUAGE
  CAPITAL_RAISE_LANGUAGE
  GUIDANCE_CUT
  UNCERTAINTY_DISCLOSURE
  FDA_CATALYST_MENTION
  TRIAL_CATALYST_MENTION
  PRODUCT_LAUNCH_MENTION
  LAYOFF_ANNOUNCEMENT

  // News facts
  BANKRUPTCY_RISK_INDICATOR
  FINANCING_ANNOUNCEMENT
  LITIGATION_ACTION
  REGULATORY_ACTION
  MA_ANNOUNCEMENT
  STRATEGIC_ALTERNATIVES
  MANAGEMENT_TURNOVER

  // Macro/Government facts
  INTEREST_RATE_DECISION
  CPI_RELEASE
  UNEMPLOYMENT_DATA
  INDUSTRIAL_PRODUCTION
  CENTRAL_BANK_ANNOUNCEMENT

  // FDA/Clinical facts
  PDUFA_DATE
  TRIAL_RESULT
  FDA_HOLD
  FDA_REJECTION
  FDA_APPROVAL
  SAFETY_NOTICE
}

model FilingFact {
  id          String    @id @default(uuid())
  filingId    String    @map("filing_id")
  factType    FactType  @map("fact_type")

  data        Json
  evidence    String?   @db.Text
  confidence  Decimal?  @default(1.0)

  extractedAt DateTime  @default(now()) @map("extracted_at")

  filing      Filing    @relation(fields: [filingId], references: [id], onDelete: Cascade)

  @@index([filingId])
  @@index([factType])
  @@map("filing_facts")
}

// ============================================================================
// SIGNAL COMPUTATION
// ============================================================================

enum SignalType {
  // EDGAR signals (existing)
  DILUTION_RISK
  TOXIC_FINANCING_RISK
  DISTRESS_RISK
  VOLATILITY_SPIKE

  // Earnings signals
  LIQUIDITY_STRESS_CALL
  CAPITAL_RAISE_IMMINENT
  GUIDANCE_DETERIORATION
  MANAGEMENT_UNCERTAINTY

  // News signals
  BANKRUPTCY_INDICATOR
  FINANCING_EVENT
  LEGAL_REGULATORY_RISK
  MA_SPECULATION
  MANAGEMENT_INSTABILITY

  // Catalyst signals
  FDA_CATALYST_UPCOMING
  TRIAL_CATALYST_UPCOMING
  PRODUCT_LAUNCH_UPCOMING
  MACRO_EVENT_UPCOMING

  // Event outcome signals
  FDA_DECISION_SURPRISE
  TRIAL_RESULT_SURPRISE
  MACRO_SURPRISE

  // Peer/Factor signals
  PEER_IMPACT
  FACTOR_EXPOSURE_ALERT
}

enum SignalSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model InstrumentSignal {
  id           String         @id @default(uuid())
  instrumentId String         @map("instrument_id")
  signalType   SignalType     @map("signal_type")
  severity     SignalSeverity

  score        Decimal
  reason       String         @db.Text

  evidenceFacts Json          @map("evidence_facts")
  sourceFiling  String?       @map("source_filing_id")

  computedAt   DateTime       @default(now()) @map("computed_at")
  expiresAt    DateTime?      @map("expires_at")

  instrument   Instrument     @relation(fields: [instrumentId], references: [id], onDelete: Cascade)
  filing       Filing?        @relation(fields: [sourceFiling], references: [id], onDelete: SetNull)

  @@index([instrumentId, signalType])
  @@index([severity])
  @@index([computedAt])
  @@map("instrument_signals")
}

// ============================================================================
// EDGAR SYNC TRACKING
// ============================================================================

model EdgarSyncWatermark {
  id             String   @id @default(uuid())
  cik            String   @unique
  lastSyncedAt   DateTime @map("last_synced_at")
  lastFilingDate DateTime @map("last_filing_date")

  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@index([lastFilingDate])
  @@map("edgar_sync_watermarks")
}

// ============================================================================
// EDGAR UNIVERSE DISCOVERY TRACKING
// ============================================================================

model EdgarUniverseSync {
  id                String   @id @default(uuid())

  // Sync metadata
  syncStartedAt     DateTime @map("sync_started_at")
  syncCompletedAt   DateTime @map("sync_completed_at")
  status            String   // 'in_progress', 'completed', 'failed'

  // Discovery metrics
  totalIssuers      Int      @default(0) @map("total_issuers")
  newIssuers        Int      @default(0) @map("new_issuers")
  updatedIssuers    Int      @default(0) @map("updated_issuers")

  // Source metadata
  sourceUrl         String?  @map("source_url")
  sourceChecksum    String?  @map("source_checksum")

  // Error tracking
  errorMessage      String?  @map("error_message")

  createdAt         DateTime @default(now()) @map("created_at")

  @@index([syncCompletedAt])
  @@index([status])
  @@map("edgar_universe_syncs")
}

// ============================================================================
// CANDLE STORAGE (POLYMORPHIC: MARKETS + INSTRUMENTS)
// ============================================================================

model Candle {
  id           String   @id @default(uuid())

  // Polymorphic FKs (exactly one must be non-null)
  marketId     String?  @map("market_id")
  instrumentId String?  @map("instrument_id")

  interval     String   // "1s", "5s", "1m", "5m", "15m", "1h", "1d"
  outcome      String?  // NULL for instruments, "YES"/"NO" for markets

  open         Decimal  @db.Decimal(20, 10)
  high         Decimal  @db.Decimal(20, 10)
  low          Decimal  @db.Decimal(20, 10)
  close        Decimal  @db.Decimal(20, 10)
  volume       Decimal  @db.Decimal(20, 10) @default(0)

  timestamp    DateTime
  endTime      DateTime @map("end_time")

  source       String   // "polymarket", "tradingview", "manual"
  createdAt    DateTime @default(now()) @map("created_at")

  @@unique([marketId, instrumentId, interval, outcome, timestamp, source])
  @@index([marketId, interval, timestamp])
  @@index([instrumentId, interval, timestamp])
  @@map("candles")
}

// ============================================================================
// MULTI-SOURCE DOCUMENT STORAGE
// ============================================================================

enum DocumentType {
  SEC_FILING
  EARNINGS_TRANSCRIPT
  NEWS_ARTICLE
  FDA_ANNOUNCEMENT
  CLINICAL_TRIAL
  MACRO_EVENT
}

model Document {
  id              String         @id @default(uuid())
  documentType    DocumentType   @map("document_type")

  // Source identity
  sourceId        String         @unique @map("source_id")
  sourceUrl       String?        @map("source_url")

  // Classification
  title           String
  publishedAt     DateTime       @map("published_at")

  // Status pipeline (same as Filing)
  status          FilingStatus   @default(PENDING)
  storagePath     String?        @map("storage_path")
  contentHash     String?        @map("content_hash")

  // Metadata
  metadata        Json?

  // Processing
  errorMessage    String?        @map("error_message")
  downloadedAt    DateTime?      @map("downloaded_at")
  parsedAt        DateTime?      @map("parsed_at")

  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  // Relations
  content         DocumentContent?
  facts           DocumentFact[]
  instruments     DocumentInstrument[]

  @@index([documentType, status])
  @@index([publishedAt])
  @@map("documents")
}

model DocumentContent {
  id           String   @id @default(uuid())
  documentId   String   @unique @map("document_id")
  fullText     String   @db.Text
  structured   Json?
  wordCount    Int      @default(0) @map("word_count")
  parsedAt     DateTime @default(now()) @map("parsed_at")

  document     Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@map("document_contents")
}

model DocumentInstrument {
  id           String     @id @default(uuid())
  documentId   String     @map("document_id")
  instrumentId String     @map("instrument_id")
  relevance    Decimal    @default(1.0)
  matchMethod  String     @map("match_method")

  document     Document   @relation(fields: [documentId], references: [id], onDelete: Cascade)
  instrument   Instrument @relation(fields: [instrumentId], references: [id], onDelete: Cascade)

  @@unique([documentId, instrumentId])
  @@index([instrumentId])
  @@map("document_instruments")
}

model DocumentFact {
  id           String       @id @default(uuid())
  documentId   String       @map("document_id")
  factType     FactType     @map("fact_type")
  data         Json
  evidence     String?      @db.Text
  confidence   Decimal?     @default(1.0)
  extractedAt  DateTime     @default(now()) @map("extracted_at")

  document     Document     @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([factType])
  @@map("document_facts")
}

// ============================================================================
// ENTITY ENRICHMENT
// ============================================================================

enum IndustryType {
  PHARMACEUTICAL
  BIOTECHNOLOGY
  MINING
  ENERGY
  TECHNOLOGY
  FINANCE
  HEALTHCARE
  CONSUMER
  INDUSTRIAL
  MATERIALS
  UTILITIES
  REAL_ESTATE
  OTHER
}

enum SectorType {
  HEALTHCARE
  MATERIALS
  ENERGY
  FINANCIALS
  CONSUMER_DISCRETIONARY
  CONSUMER_STAPLES
  INDUSTRIALS
  TECHNOLOGY
  COMMUNICATION_SERVICES
  UTILITIES
  REAL_ESTATE
}

model InstrumentClassification {
  id           String       @id @default(uuid())
  instrumentId String       @unique @map("instrument_id")
  industry     IndustryType
  sector       SectorType
  confidence   Decimal      @default(1.0)
  rationale    String?      @db.Text
  classifiedAt DateTime     @default(now()) @map("classified_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  instrument   Instrument   @relation(fields: [instrumentId], references: [id], onDelete: Cascade)

  @@index([industry])
  @@index([sector])
  @@map("instrument_classifications")
}

model CompetitorRelationship {
  id               String     @id @default(uuid())
  instrumentId     String     @map("instrument_id")
  competitorId     String     @map("competitor_id")
  relationshipType String     @map("relationship_type")
  confidence       Decimal    @default(0.7)
  rationale        String?    @db.Text
  discoveredAt     DateTime   @default(now()) @map("discovered_at")
  updatedAt        DateTime   @updatedAt @map("updated_at")

  instrument       Instrument @relation("Instrument", fields: [instrumentId], references: [id], onDelete: Cascade)
  competitor       Instrument @relation("Competitor", fields: [competitorId], references: [id], onDelete: Cascade)

  @@unique([instrumentId, competitorId])
  @@index([instrumentId])
  @@index([competitorId])
  @@map("competitor_relationships")
}

enum FactorType {
  COMMODITY_GOLD
  COMMODITY_SILVER
  COMMODITY_OIL
  COMMODITY_NATURAL_GAS
  COMMODITY_COPPER
  INTEREST_RATE_10Y
  INTEREST_RATE_FED_FUNDS
  INDEX_SPX
  INDEX_NASDAQ
  CURRENCY_USD
  VOLATILITY_VIX
}

model FactorExposure {
  id           String      @id @default(uuid())
  instrumentId String      @map("instrument_id")
  factorType   FactorType  @map("factor_type")
  direction    String
  magnitude    Decimal
  confidence   Decimal     @default(0.7)
  rationale    String?     @db.Text
  discoveredAt DateTime    @default(now()) @map("discovered_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  instrument   Instrument  @relation(fields: [instrumentId], references: [id], onDelete: Cascade)

  @@unique([instrumentId, factorType])
  @@index([factorType])
  @@map("factor_exposures")
}

// ============================================================================
// UNIFIED SYNC TRACKING
// ============================================================================

model SyncWatermark {
  id             String       @id @default(uuid())
  sourceType     String       @map("source_type")
  sourceKey      String       @map("source_key")
  lastSyncedAt   DateTime     @map("last_synced_at")
  lastItemDate   DateTime     @map("last_item_date")
  metadata       Json?
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  @@unique([sourceType, sourceKey])
  @@index([lastItemDate])
  @@map("sync_watermarks")
}

// ============================================================================
// WATCHLIST FUNCTIONALITY
// ============================================================================

model Watchlist {
  id        String   @id @default(uuid())
  name      String
  sortOrder Int      @map("sort_order") // 1-9 for keyboard shortcuts
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  items     WatchlistItem[]

  @@unique([sortOrder])
  @@index([sortOrder])
  @@map("watchlists")
}

model WatchlistItem {
  id          String   @id @default(uuid())
  watchlistId String   @map("watchlist_id")
  marketId    String   @map("market_id")
  addedAt     DateTime @default(now()) @map("added_at")

  watchlist   Watchlist @relation(fields: [watchlistId], references: [id], onDelete: Cascade)
  market      Market    @relation(fields: [marketId], references: [id], onDelete: Cascade)

  @@unique([watchlistId, marketId])
  @@index([watchlistId])
  @@index([marketId])
  @@map("watchlist_items")
}
