version: '3.8'

# Production Worker Orchestration
# Runs all background jobs in separate containers
# Deploy on a single DigitalOcean Droplet or Kubernetes cluster

services:
  # Market Sync Worker - Syncs markets and orderbook data
  market-sync:
    image: ${DOCKER_REGISTRY:-registry.digitalocean.com/terminal}/terminal-worker:${VERSION:-latest}
    container_name: worker-market-sync
    restart: unless-stopped
    command: ["node", "dist/jobs/runners/market-sync-runner.js"]
    env_file:
      - .env
    networks:
      - terminal-workers
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # Position Update Worker - Updates user positions
  position-update:
    image: ${DOCKER_REGISTRY:-registry.digitalocean.com/terminal}/terminal-worker:${VERSION:-latest}
    container_name: worker-position-update
    restart: unless-stopped
    command: ["node", "dist/jobs/runners/position-update-runner.js"]
    env_file:
      - .env
    networks:
      - terminal-workers
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # EDGAR Universe Discovery Worker - Populates instrument universe
  edgar-universe:
    image: ${DOCKER_REGISTRY:-registry.digitalocean.com/terminal}/terminal-worker:${VERSION:-latest}
    container_name: worker-edgar-universe
    restart: unless-stopped
    command: ["node", "dist/jobs/runners/edgar-universe-runner.js"]
    env_file:
      - .env
    networks:
      - terminal-workers
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # EDGAR Filing Sync Worker - Downloads and processes filings
  edgar-sync:
    image: ${DOCKER_REGISTRY:-registry.digitalocean.com/terminal}/terminal-worker:${VERSION:-latest}
    container_name: worker-edgar-sync
    restart: unless-stopped
    command: ["node", "dist/jobs/runners/edgar-sync-runner.js"]
    env_file:
      - .env
    networks:
      - terminal-workers
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # News Worker - Fetches and processes news articles
  news-worker:
    image: ${DOCKER_REGISTRY:-registry.digitalocean.com/terminal}/terminal-worker:${VERSION:-latest}
    container_name: worker-news
    restart: unless-stopped
    command: ["node", "dist/jobs/runners/news-worker-runner.js"]
    env_file:
      - .env
    networks:
      - terminal-workers
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  

  # Transcripts Worker - Ingests and analyzes earnings call transcripts
  transcripts-worker:
    image: ${DOCKER_REGISTRY:-registry.digitalocean.com/terminal}/terminal-worker:${VERSION:-latest}
    container_name: worker-transcripts
    restart: unless-stopped
    command: ["node", "dist/jobs/runners/transcripts-runner.js"]
    env_file:
      - .env
    environment:
      - TRANSCRIPTS_SYNC_INTERVAL_MS=${TRANSCRIPTS_SYNC_INTERVAL_MS:-14400000}
      - TRANSCRIPTS_BATCH_SIZE=${TRANSCRIPTS_BATCH_SIZE:-10}
      - TRANSCRIPTS_BACKFILL_ENABLED=${TRANSCRIPTS_BACKFILL_ENABLED:-false}
      - TRANSCRIPTS_BACKFILL_LOOKBACK_DAYS=${TRANSCRIPTS_BACKFILL_LOOKBACK_DAYS:-180}
      - TRANSCRIPTS_STORAGE_TYPE=${TRANSCRIPTS_STORAGE_TYPE:-local}
      - TRANSCRIPTS_STORAGE_PATH=${TRANSCRIPTS_STORAGE_PATH:-./storage/transcripts}
      - TRANSCRIPTS_S3_BUCKET=${TRANSCRIPTS_S3_BUCKET}
      - TRANSCRIPTS_S3_ENDPOINT=${TRANSCRIPTS_S3_ENDPOINT}
      - TRANSCRIPTS_S3_REGION=${TRANSCRIPTS_S3_REGION}
      - TRANSCRIPTS_S3_ACCESS_KEY=${TRANSCRIPTS_S3_ACCESS_KEY}
      - TRANSCRIPTS_S3_SECRET_KEY=${TRANSCRIPTS_S3_SECRET_KEY}
      - FMP_API_KEY=${FMP_API_KEY}
      - FMP_API_RATE_LIMIT_MS=${FMP_API_RATE_LIMIT_MS:-350}
    volumes:
      - ./storage/transcripts:/app/storage/transcripts
    networks:
      - terminal-workers
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # Entity Enrichment Worker - Enriches instrument metadata
  entity-enrichment:
    image: ${DOCKER_REGISTRY:-registry.digitalocean.com/terminal}/terminal-worker:${VERSION:-latest}
    container_name: worker-entity-enrichment
    restart: unless-stopped
    command: ["node", "dist/jobs/runners/entity-enrichment-runner.js"]
    env_file:
      - .env
    networks:
      - terminal-workers
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # Signal Computation Worker - Computes derived signals
  signal-computation:
    image: ${DOCKER_REGISTRY:-registry.digitalocean.com/terminal}/terminal-worker:${VERSION:-latest}
    container_name: worker-signal-computation
    restart: unless-stopped
    command: ["node", "dist/jobs/runners/signal-computation-runner.js"]
    env_file:
      - .env
    networks:
      - terminal-workers
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # Search Indexer Worker - Indexes content in OpenSearch
  search-indexer:
    image: ${DOCKER_REGISTRY:-registry.digitalocean.com/terminal}/terminal-worker:${VERSION:-latest}
    container_name: worker-search-indexer
    restart: unless-stopped
    command: ["node", "dist/jobs/runners/search-indexer-runner.js"]
    env_file:
      - .env
    networks:
      - terminal-workers
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # Watchtower - Auto-update containers when new images are pushed
  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_POLL_INTERVAL=300  # Check every 5 minutes
      - WATCHTOWER_CLEANUP=true       # Remove old images
      - WATCHTOWER_INCLUDE_STOPPED=false
      - WATCHTOWER_LABEL_ENABLE=false
      - DOCKER_API_VERSION=1.44       # Match Docker daemon version
    networks:
      - terminal-workers
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"

networks:
  terminal-workers:
    driver: bridge