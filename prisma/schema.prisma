// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Market {
  id                 String   @id
  question           String
  outcomes           Json     // Array of outcome names (e.g., ["Yes", "No"])
  expiryDate         DateTime
  liquidity          Decimal
  volume24h          Decimal
  categoryTag        String?
  marketSlug         String
  active             Boolean  @default(true)
  tokens             Json     // JSON object: { "YES": "0x...", "NO": "0x..." }
  polymarketMarketId String?  @map("polymarket_market_id")
  yesPrice           Decimal? @map("yes_price")
  noPrice            Decimal? @map("no_price")
  volume             Decimal? @map("volume")
  lastIndexedBlock   BigInt?  @map("last_indexed_block")
  completedEarly     Boolean  @default(false) @map("completed_early")
  createdAt          DateTime @default(now())
  lastUpdated        DateTime @updatedAt @map("last_updated")

  trades    Trade[]
  positions Position[]

  @@index([active])
  @@index([categoryTag])
  @@index([expiryDate])
  @@index([polymarketMarketId])
  @@map("markets")
}

model Trade {
  id            String    @id @default(uuid())
  walletAddress String
  marketId      String
  outcome       String    // "YES" or "NO"
  side          String    // "buy" or "sell"
  price         Decimal
  size          Decimal
  txHash        String?
  blockNumber   BigInt?
  gasUsed       BigInt?
  fee           Decimal?
  timestamp     DateTime  @default(now())
  confirmedAt   DateTime?

  market Market @relation(fields: [marketId], references: [id])

  @@index([walletAddress])
  @@index([marketId])
  @@index([timestamp])
  @@map("trades")
}

model Position {
  id            String   @id @default(uuid())
  walletAddress String
  marketId      String
  outcome       String   // "YES" or "NO"
  avgPrice      Decimal
  size          Decimal
  realizedPnl   Decimal  @default(0)
  unrealizedPnl Decimal  @default(0)
  lastTradeAt   DateTime
  updatedAt     DateTime @updatedAt

  market Market @relation(fields: [marketId], references: [id])

  @@unique([walletAddress, marketId, outcome])
  @@index([walletAddress])
  @@index([marketId])
  @@map("positions")
}

model OrderbookSnapshot {
  id        String   @id @default(uuid())
  marketId  String
  outcome   String   // "YES" or "NO"
  bids      Json     // Array of {price, size}
  asks      Json     // Array of {price, size}
  timestamp DateTime @default(now())
  expiresAt DateTime

  @@unique([marketId, outcome])
  @@index([expiresAt])
  @@map("orderbook_snapshots")
}

model OrderbookEvent {
  id        String   @id @default(uuid())
  marketId  String
  outcome   String   // "YES" or "NO"
  bestBid   Decimal? @map("best_bid")
  bestAsk   Decimal? @map("best_ask")
  midPrice  Decimal? @map("mid_price")
  timestamp DateTime
  source    String   @default("realtime") // "historical" | "realtime"

  @@index([marketId, outcome, timestamp])
  @@index([timestamp])
  @@index([source])
  @@map("orderbook_events")
}

model TradeEvent {
  id        String   @id @default(uuid())
  marketId  String
  outcome   String   // "YES" or "NO"
  price     Decimal
  size      Decimal
  timestamp DateTime
  source    String   @default("realtime") // "historical" | "realtime"

  @@unique([marketId, outcome, timestamp, price, size])
  @@index([marketId, outcome, timestamp])
  @@index([timestamp])
  @@index([source])
  @@map("trade_events")
}

model MarketBackfill {
  marketId             String    @id
  status               String    // "pending" | "in_progress" | "completed" | "failed"
  tradeEventsCount     Int       @default(0)
  orderbookEventsCount Int       @default(0)
  earliestTimestamp    DateTime?
  latestTimestamp      DateTime?
  errorMessage         String?
  startedAt            DateTime?
  completedAt          DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  @@index([status])
  @@map("market_backfills")
}

model AuthNonce {
  walletAddress String   @id @map("wallet_address")
  nonce         String
  timestamp     Int
  expiresAt     DateTime @map("expires_at")
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([expiresAt])
  @@map("auth_nonces")
}
